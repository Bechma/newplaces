var v=Object.defineProperty;var k=(i,t,e)=>t in i?v(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e;var s=(i,t,e)=>(k(i,typeof t!="symbol"?t+"":t,e),e);const b=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))n(a);new MutationObserver(a=>{for(const l of a)if(l.type==="childList")for(const r of l.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function e(a){const l={};return a.integrity&&(l.integrity=a.integrity),a.referrerpolicy&&(l.referrerPolicy=a.referrerpolicy),a.crossorigin==="use-credentials"?l.credentials="include":a.crossorigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function n(a){if(a.ep)return;a.ep=!0;const l=e(a);fetch(a.href,l)}};b();const d="DRAW_CANVAS",m="MESSAGE_SSE",p="SEND_PIXEL",g="SETUP_PALETTE",u="COLOR_CHOOSER";class c{static emit(t,...e){this.map[t]&&this.map[t](...e)}static subscribe(t,e){this.map[t]=e}}s(c,"map",{});function h(i){const t=i>>24&255,e=i>>16&255,n=i>>8&255,a=i&255;return`rgba(${t},${e},${n},${a})`}class P{constructor(t=0,e=0,n=0,a=1,l=0,r=0,y=!1,x=0,E=0,S=0,X=0,Y=0,C=0){s(this,"x");s(this,"y");s(this,"color");s(this,"scale");s(this,"initialX");s(this,"initialY");s(this,"isDragging");s(this,"panStartX");s(this,"panStartY");s(this,"clickedX");s(this,"clickedY");s(this,"originalClickedX");s(this,"originalClickedY");s(this,"middleX");s(this,"middleY");s(this,"camera");s(this,"position");s(this,"zoom");s(this,"selectedPixel");s(this,"canvas");s(this,"ctx");s(this,"px");this.x=t,this.y=e,this.color=n,this.scale=a,this.initialX=l,this.initialY=r,this.isDragging=y,this.panStartX=x,this.panStartY=E,this.originalClickedX=this.clickedX=S,this.originalClickedY=this.clickedY=X,this.middleX=Y,this.middleY=C,this.camera=document.getElementById("camera"),this.position=document.getElementById("position"),this.zoom=document.getElementById("zoom"),this.selectedPixel=document.getElementById("pixel"),this.canvas=document.getElementById("canvas"),this.ctx=this.canvas.getContext("2d"),this.px=document.getElementById("pixel")}initPan(t){this.panStartX=t.pageX,this.panStartY=t.pageY,this.initialX=this.x,this.initialY=this.y,this.isDragging=!0}panCamera(t){const e=this.canvas.getBoundingClientRect();this.originalClickedX=Math.floor((t.clientX-e.left)/this.scale),this.clickedX=Math.min(Math.max(this.originalClickedX,0),1999),this.originalClickedY=Math.floor((t.clientY-e.top)/this.scale),this.clickedY=Math.min(Math.max(this.originalClickedY,0),1999),this.middleX=Math.floor((this.camera.offsetWidth/2-e.left)/this.scale),this.middleY=Math.floor((this.camera.offsetHeight/4-e.top)/this.scale),this.isDragging&&(this.setX(this.initialX+t.pageX-this.panStartX),this.setY(this.initialY+t.pageY-this.panStartY)),this.updateCamera()}toggleZoom(t){const e=t.pageX-this.zoom.offsetWidth/2,n=t.pageY-this.zoom.offsetHeight/2,a=Math.abs(t.deltaY/100)+1;let l;t.deltaY<0?(l=a,this.scale*l>35&&(l=35/this.scale)):(l=1/a,this.scale*l<.5&&(l=.5/this.scale)),this.scale*=l,this.setX(e-(e-this.x)*l),this.setY(n-(n-this.y)*l),this.updateCamera()}clickPixel(){this.initialX==this.x&&this.initialY==this.y&&this.originalClickedY>=0&&this.originalClickedY<2e3&&this.originalClickedX>=0&&this.originalClickedX<2e3&&this.px.style.display!="none"&&c.emit(p,this.clickedX,this.clickedY,this.color)}setDragging(t){this.isDragging=t}setColor(t){this.color=t,this.px.style.display="block",this.px.style.backgroundColor=h(t)}hidePx(){this.px.style.display="none"}paintPixel(t,e,n){this.ctx.fillStyle=h(n),this.ctx.fillRect(t,e,1,1)}drawAllCanvas(t){this.ctx.putImageData(t,0,0)}updateCamera(){this.position.style.transform=`translateX(${this.x}px) translateY(${this.y}px)`,this.zoom.style.transform=`scale(${this.scale})`,this.selectedPixel.style.left=`${this.clickedX}px`,this.selectedPixel.style.top=`${this.clickedY}px`}setX(t){(this.middleX>=0&&this.middleX<2e3||this.middleX<0&&this.x>t||this.middleX>=2e3&&this.x<=t)&&(this.x=t)}setY(t){(this.middleY>=0&&this.middleY<2e3||this.middleY<0&&this.y>t||this.middleY>=2e3&&this.y<=t)&&(this.y=t)}}class L{constructor(t){s(this,"eventSource");s(this,"url");this.url=t,this.init()}init(){this.eventSource=new EventSource(this.url+"events"),this.eventSource.onopen=async t=>await this.onopen(t),this.eventSource.onerror=t=>this.onerror(t),this.eventSource.onmessage=t=>this.onmessage(t)}async onopen(t){const a=await(await(await fetch(this.url+"canvas",{headers:{Accept:"application/octet-stream"}})).blob()).arrayBuffer(),l=new Uint8ClampedArray(a);c.emit(d,new ImageData(l,2e3,2e3))}onerror(t){this.eventSource.close(),setTimeout(()=>{this.init()},3e3)}onmessage(t){const{x:e,y:n,color:a}=JSON.parse(t.data);c.emit(m,e,n,a)}sendPixel(t,e,n){fetch(this.url+"pixel",{method:"POST",body:JSON.stringify({x:t,y:e,color:n}),headers:{"Content-Type":"application/json"}})}getPalette(){fetch(this.url+"palette",{headers:{Accept:"application/json"}}).then(t=>{t.json().then(e=>{c.emit(g,e)})})}}class A{constructor(){s(this,"palette");this.palette=document.getElementById("palette")}setUp(t){t.forEach(e=>{const n=document.createElement("div");n.className="picker",n.style.background=h(e),n.onclick=()=>c.emit(u,e),this.palette.appendChild(n)})}}const o=new P,f=new L("https://newplace.herokuapp.com/"),O=new A;c.subscribe(m,(i,t,e)=>o.paintPixel(i,t,e));c.subscribe(p,(i,t,e)=>{f.sendPixel(i,t,e)});c.subscribe(d,i=>o.drawAllCanvas(i));c.subscribe(g,i=>O.setUp(i));c.subscribe(u,i=>o.setColor(i));f.getPalette();D();function D(){o.camera.addEventListener("mousedown",i=>o.initPan(i)),o.camera.addEventListener("mouseup",()=>o.setDragging(!1)),o.camera.addEventListener("mouseout",()=>o.setDragging(!1)),o.camera.addEventListener("mousemove",i=>o.panCamera(i)),o.camera.addEventListener("wheel",i=>o.toggleZoom(i),{passive:!1}),o.camera.addEventListener("click",()=>o.clickPixel()),document.getElementById("deselect").addEventListener("click",()=>o.hidePx())}
